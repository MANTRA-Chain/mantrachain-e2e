from concurrent.futures import ThreadPoolExecutor, as_completed

import pytest
import requests
from pystarport import ports

from .utils import CONTRACTS, deploy_contract


def call(port, params):
    url = f"http://127.0.0.1:{port}"
    rsp = requests.post(url, json=params)
    assert rsp.status_code == 200
    return rsp.json()


def run_test(provider, concurrent, batch, expect_cb):
    contract = deploy_contract(provider.w3, CONTRACTS["TestExploitContract"])
    param = {
        "jsonrpc": "2.0",
        "method": "eth_call",
        "params": [
            {
                "data": "0x5e67164c",
                "to": contract.address,
            },
            "latest",
        ],
        "id": 1,
    }
    params = []
    for _ in range(batch):
        params.append(param)
    with ThreadPoolExecutor(concurrent) as executor:
        p = ports.evmrpc_port(provider.base_port(0))
        tasks = [executor.submit(call, p, params) for _ in range(0, concurrent)]
        results = [future.result() for future in as_completed(tasks)]
    assert len(results) == concurrent
    for result in results:
        expect_cb(result)


@pytest.mark.skip(reason="skipping test_large_call")
def test_large_call(mantra):
    concurrent = 10
    batch = 5

    def expect_cb(result):
        found = False
        for item in result:
            if "error" in item and "response too large" in str(
                item["error"].get("message", "")
            ):
                found = True
        assert found, "no limit found"

    run_test(mantra, concurrent, batch, expect_cb)
